{% extends 'base.html' %}

{% block title %}Approve Requests - AMS{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div>
        <h1 class="text-title-desktop hidden md:block text-black">Approve Access Requests</h1>
        <h1 class="text-title-mobile md:hidden text-black">Approve Requests</h1>
        <p class="text-sm text-black/70 mt-1">Review and approve employee access requests</p>
    </div>

    <!-- Requests List -->
    <div class="space-y-4">
        {% for request in page_obj %}
        <div class="bg-white border border-light-blue rounded-2xl p-5 md:p-6 hover:shadow-md transition-shadow duration-200">
            <!-- Header -->
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-black">{{ request.requester.username }}</h3>
                    <p class="text-sm text-black/60 mt-1">{{ request.ep_no }}</p>
                    <p class="text-xs text-black/50 mt-1">{{ request.created_at|date:"d M Y, H:i" }}</p>
                </div>
                <span class="badge-late flex-shrink-0 ml-3">Pending</span>
            </div>

            <!-- Details -->
            <div class="space-y-3 text-sm mb-5">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-semibold text-black/60 uppercase">Employee Number</span>
                    <span class="text-black font-bold">{{ request.ep_no }}</span>
                </div>
                
                <div class="flex justify-between items-center">
                    <span class="text-xs font-semibold text-black/60 uppercase">Access Type</span>
                    <span class="text-black font-medium">{{ request.get_access_type_display }}</span>
                </div>
                
                {% if request.access_type == 'date_range' %}
                <div class="flex justify-between items-center">
                    <span class="text-xs font-semibold text-black/60 uppercase">Date Range</span>
                    <span class="text-black font-medium">{{ request.access_from|date:"d M Y" }} - {{ request.access_to|date:"d M Y" }}</span>
                </div>
                {% endif %}

                <div class="flex justify-between items-center">
                    <span class="text-xs font-semibold text-black/60 uppercase">Company</span>
                    <span class="text-black font-medium">{{ request.company.name }}</span>
                </div>

                <div class="pt-2 border-t border-light-blue/30">
                    <span class="text-xs font-semibold text-black/60 uppercase block mb-2">Justification</span>
                    <p class="text-black bg-light-blue/10 p-3 rounded-xl">{{ request.justification }}</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col md:flex-row gap-2 pt-4 border-t border-light-blue/30">
                <form method="post" action="{% url 'core:approve_request' request.id %}" class="flex-1">
                    {% csrf_token %}
                    <button type="submit" class="w-full px-5 py-3 bg-dark-blue text-cream rounded-xl font-bold hover:bg-black active:scale-[0.98] transition-all duration-200 text-sm">
                        Approve
                    </button>
                </form>
                
                <button 
                    onclick="showRejectModal({{ request.id }})"
                    class="flex-1 px-5 py-3 bg-light-blue text-black rounded-xl font-bold hover:bg-light-blue/70 active:scale-[0.98] transition-all duration-200 text-sm"
                >
                    Reject
                </button>
            </div>
        </div>
        {% empty %}
        <div class="bg-white border border-light-blue rounded-2xl p-12 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-black/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-black/60">No pending requests</p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="flex justify-center items-center gap-2">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}" class="px-4 py-2 bg-cream border border-light-blue text-black rounded-xl font-semibold hover:bg-light-blue transition-colors duration-200">
            Previous
        </a>
        {% endif %}
        
        <span class="px-4 py-2 bg-dark-blue text-cream rounded-xl font-bold">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
        
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="px-4 py-2 bg-cream border border-light-blue text-black rounded-xl font-semibold hover:bg-light-blue transition-colors duration-200">
            Next
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white border-2 border-light-blue rounded-2xl p-6 md:p-8 max-w-md w-full">
        <h3 class="text-xl font-bold text-black mb-4">Reject Request</h3>
        <form id="rejectForm" method="post">
            {% csrf_token %}
            <div class="mb-6">
                <label class="block text-xs font-semibold text-black/70 uppercase mb-2">
                    Rejection Reason (Optional)
                </label>
                <textarea 
                    name="reason" 
                    rows="4" 
                    placeholder="Explain why this request is being rejected..."
                    class="w-full px-4 py-3 bg-white border-2 border-light-blue rounded-xl focus:ring-2 focus:ring-dark-blue focus:border-dark-blue transition-all duration-200 text-black placeholder:text-black/40 text-sm"
                ></textarea>
            </div>
            <div class="flex gap-2">
                <button type="submit" class="flex-1 px-5 py-3 bg-black text-cream rounded-xl font-bold hover:bg-black/80 active:scale-95 transition-all duration-200 text-sm">
                    Reject
                </button>
                <button type="button" onclick="hideRejectModal()" class="flex-1 px-5 py-3 bg-light-blue text-black rounded-xl font-bold hover:bg-light-blue/70 active:scale-95 transition-all duration-200 text-sm">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showRejectModal(requestId) {
    const modal = document.getElementById('rejectModal');
    const form = document.getElementById('rejectForm');
    form.action = `/reject-request/${requestId}/`;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function hideRejectModal() {
    const modal = document.getElementById('rejectModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideRejectModal();
    }
});

// Close modal on backdrop click
document.getElementById('rejectModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideRejectModal();
    }
});
</script>
{% endblock %}
