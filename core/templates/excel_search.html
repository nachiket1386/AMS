{% extends 'base.html' %}

{% block title %}Search Attendance Data{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>üîç Search & Filter Attendance Data</h2>
    
    <!-- Search Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="searchForm">
                <div class="row">
                    <div class="col-md-3">
                        <label>EP NO</label>
                        <input type="text" id="epNo" class="form-control" placeholder="PP5000014534">
                    </div>
                    <div class="col-md-3">
                        <label>Employee Name</label>
                        <input type="text" id="employeeName" class="form-control" placeholder="John Doe">
                    </div>
                    <div class="col-md-2">
                        <label>Date From</label>
                        <input type="date" id="dateFrom" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label>Date To</label>
                        <input type="date" id="dateTo" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label>Status</label>
                        <select id="status" class="form-control">
                            <option value="">All</option>
                            <option value="P">Present</option>
                            <option value="A">Absent</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Search</button>
                    <button type="button" id="resetBtn" class="btn btn-secondary">Reset</button>
                    <button type="button" id="exportBtn" class="btn btn-success">üì• Export Results</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Results -->
    <div class="card">
        <div class="card-body">
            <h5>Results: <span id="resultCount">0</span> records</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>EP NO</th>
                            <th>Name</th>
                            <th>Contractor</th>
                            <th>Date</th>
                            <th>Shift</th>
                            <th>Hours</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr><td colspan="7" class="text-center">Enter search criteria and click Search</td></tr>
                    </tbody>
                </table>
            </div>
            <nav id="pagination"></nav>
        </div>
    </div>
</div>

<script>
let currentPage = 1;

document.getElementById('searchForm').addEventListener('submit', (e) => {
    e.preventDefault();
    currentPage = 1;
    search();
});

document.getElementById('resetBtn').addEventListener('click', () => {
    document.getElementById('searchForm').reset();
});

document.getElementById('exportBtn').addEventListener('click', exportResults);

async function search() {
    const params = new URLSearchParams({
        ep_no: document.getElementById('epNo').value,
        employee_name: document.getElementById('employeeName').value,
        date_from: document.getElementById('dateFrom').value,
        date_to: document.getElementById('dateTo').value,
        status: document.getElementById('status').value,
        page: currentPage
    });
    
    const response = await fetch(`/api/excel/attendance/?${params}`);
    const data = await response.json();
    
    if (data.success) {
        displayResults(data);
    }
}

function displayResults(data) {
    document.getElementById('resultCount').textContent = data.total;
    const tbody = document.getElementById('resultsBody');
    tbody.innerHTML = '';
    
    if (data.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No results found</td></tr>';
        return;
    }
    
    data.data.forEach(record => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${record.ep_no}</td>
            <td>${record.ep_name}</td>
            <td>${record.contractor_name}</td>
            <td>${record.punchdate}</td>
            <td>${record.shift}</td>
            <td>${record.hours_worked || 'N/A'}</td>
            <td><span class="badge badge-${record.status === 'P' ? 'success' : 'danger'}">${record.status}</span></td>
        `;
    });
}

async function exportResults() {
    const filters = {
        ep_no: document.getElementById('epNo').value,
        date_from: document.getElementById('dateFrom').value,
        date_to: document.getElementById('dateTo').value,
        status: document.getElementById('status').value
    };
    
    const response = await fetch('/api/excel/export/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            data_type: 'punch_records',
            filters: filters,
            format: 'csv'
        })
    });
    
    if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'attendance_export.csv';
        a.click();
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
