{% extends 'base.html' %}
{% load static %}

{% block title %}Excel Data Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-card h3 {
        font-size: 2.5rem;
        margin: 10px 0;
        color: #007bff;
    }
    
    .stat-card.success h3 { color: #28a745; }
    .stat-card.warning h3 { color: #ffc107; }
    .stat-card.danger h3 { color: #dc3545; }
    
    .date-range-selector {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .recent-records {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .pending-requests {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h2>üìä Attendance Data Dashboard</h2>
    
    <!-- Date Range Selector -->
    <div class="date-range-selector">
        <form id="dateRangeForm" class="form-inline">
            <label class="mr-2">Date Range:</label>
            <input type="date" id="dateFrom" class="form-control mr-2" required>
            <label class="mr-2">to</label>
            <input type="date" id="dateTo" class="form-control mr-2" required>
            <button type="submit" class="btn btn-primary">Apply</button>
            <button type="button" id="thisMonthBtn" class="btn btn-secondary ml-2">This Month</button>
        </form>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <h6>Total Records</h6>
            <h3 id="totalRecords">0</h3>
            <p class="text-muted">Attendance entries</p>
        </div>
        
        <div class="stat-card success">
            <h6>Present</h6>
            <h3 id="presentCount">0</h3>
            <p class="text-muted">Days present</p>
        </div>
        
        <div class="stat-card danger">
            <h6>Absent</h6>
            <h3 id="absentCount">0</h3>
            <p class="text-muted">Days absent</p>
        </div>
        
        <div class="stat-card">
            <h6>Unique Employees</h6>
            <h3 id="uniqueEmployees">0</h3>
            <p class="text-muted">Total employees</p>
        </div>
    </div>
    
    <!-- Pending Requests Summary -->
    <div class="pending-requests">
        <h5>‚è≥ Pending Requests</h5>
        <div class="row">
            <div class="col-md-4">
                <div class="alert alert-warning">
                    <strong>Overtime:</strong> <span id="pendingOvertime">0</span> requests
                </div>
            </div>
            <div class="col-md-4">
                <div class="alert alert-warning">
                    <strong>Partial Day:</strong> <span id="pendingPartialDay">0</span> requests
                </div>
            </div>
            <div class="col-md-4">
                <div class="alert alert-warning">
                    <strong>Regularization:</strong> <span id="pendingRegularization">0</span> requests
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Records -->
    <div class="recent-records">
        <h5>üìã Recent Attendance Records</h5>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>EP NO</th>
                        <th>Employee Name</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Hours Worked</th>
                    </tr>
                </thead>
                <tbody id="recentRecordsBody">
                    <tr>
                        <td colspan="5" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="text-center mt-4">
        <a href="{% url 'core:excel_upload' %}" class="btn btn-primary btn-lg">
            üì§ Upload New File
        </a>
        <a href="{% url 'core:excel_search' %}" class="btn btn-info btn-lg ml-2">
            üîç Search & Filter
        </a>
        <a href="{% url 'core:excel_import_history' %}" class="btn btn-secondary btn-lg ml-2">
            üìã Import History
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Set default date range (current month)
function setThisMonth() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    
    document.getElementById('dateFrom').valueAsDate = firstDay;
    document.getElementById('dateTo').valueAsDate = today;
}

// Initialize
setThisMonth();
loadDashboardData();

// Event Listeners
document.getElementById('dateRangeForm').addEventListener('submit', (e) => {
    e.preventDefault();
    loadDashboardData();
});

document.getElementById('thisMonthBtn').addEventListener('click', () => {
    setThisMonth();
    loadDashboardData();
});

// Load Dashboard Data
async function loadDashboardData() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    try {
        const response = await fetch(`/api/excel/dashboard/?date_from=${dateFrom}&date_to=${dateTo}`);
        const data = await response.json();
        
        if (data.success) {
            updateDashboard(data);
        } else {
            console.error('Failed to load dashboard data:', data.error);
        }
    } catch (error) {
        console.error('Error loading dashboard:', error);
    }
}

// Update Dashboard
function updateDashboard(data) {
    // Update statistics
    document.getElementById('totalRecords').textContent = data.summary.total_records;
    document.getElementById('presentCount').textContent = data.summary.present_count;
    document.getElementById('absentCount').textContent = data.summary.absent_count;
    document.getElementById('uniqueEmployees').textContent = data.summary.unique_employees;
    
    // Update pending requests
    document.getElementById('pendingOvertime').textContent = data.summary.pending_requests.overtime;
    document.getElementById('pendingPartialDay').textContent = data.summary.pending_requests.partial_day;
    document.getElementById('pendingRegularization').textContent = data.summary.pending_requests.regularization;
    
    // Update recent records
    const tbody = document.getElementById('recentRecordsBody');
    tbody.innerHTML = '';
    
    if (data.recent_records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No records found</td></tr>';
    } else {
        data.recent_records.forEach(record => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${record.ep_no}</td>
                <td>${record.ep_name}</td>
                <td>${record.punchdate}</td>
                <td><span class="badge badge-${record.status === 'P' ? 'success' : 'danger'}">${record.status}</span></td>
                <td>${record.hours_worked || 'N/A'}</td>
            `;
        });
    }
}
</script>
{% endblock %}
